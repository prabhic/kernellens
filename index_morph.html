<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kernel Lens - True Morphing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .morph-stage {
            width: 800px;
            height: 600px;
            background: radial-gradient(ellipse at center, #0f1428 0%, #0a0e27 100%);
            border-radius: 20px;
            padding: 40px;
            position: relative;
        }

        .stage-label {
            position: absolute;
            top: 20px;
            left: 40px;
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }

        button {
            padding: 12px 30px;
            background: rgba(102, 126, 234, 0.2);
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 30px;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(102, 126, 234, 0.4);
            border-color: rgba(102, 126, 234, 1);
            transform: translateY(-2px);
        }

        .explanation {
            position: absolute;
            top: 60px;
            left: 40px;
            right: 40px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
            line-height: 1.6;
        }

        .morph-canvas {
            width: 100%;
            height: 400px;
            margin-top: 100px;
        }

        /* Stage visualization */
        #stage-0-to-1 .data-blob {
            fill: #f093fb;
            filter: drop-shadow(0 0 20px #f093fb);
        }

        .stage-label-text {
            font-size: 14px;
            font-weight: 700;
            fill: #0a0e27;
            text-anchor: middle;
        }

        .stage-value-text {
            font-size: 12px;
            font-weight: 600;
            fill: #0a0e27;
            text-anchor: middle;
        }
    </style>
</head>
<body>
    <div class="morph-stage">
        <div class="stage-label">Stage 0→1: Circle to Registers</div>
        <div class="explanation" id="explanation">
            Watch the fd value (circle) descend and split into CPU registers (three bars).
            The circle literally BECOMES the registers - one object morphing.
        </div>

        <svg class="morph-canvas" viewBox="0 0 400 400" id="stage-0-to-1">
            <!-- Stage markers -->
            <text x="50" y="50" fill="rgba(255,255,255,0.3)" font-size="10">USER SPACE</text>
            <line x1="0" y1="100" x2="400" y2="100" stroke="rgba(255,255,255,0.1)" stroke-width="1" stroke-dasharray="5,5"/>
            <text x="50" y="120" fill="rgba(255,255,255,0.3)" font-size="10">KERNEL SPACE</text>

            <!-- The morphing data blob -->
            <g id="morphing-blob">
                <!-- Path that will morph from circle to three bars -->
                <path class="data-blob" id="morph-path">
                    <!-- Shape morphing: Circle → Elongated → Splitting → Three Bars -->
                    <animate id="morph-anim" attributeName="d"
                        begin="indefinite"
                        dur="3s"
                        fill="freeze"
                        values="
                            M 200,50 m -30,0 a 30,30 0 1,0 60,0 a 30,30 0 1,0 -60,0;
                            M 190,60 L 210,60 L 210,120 L 190,120 Z;
                            M 180,80 L 220,80 L 220,100 L 180,100 Z M 180,110 L 220,110 L 220,130 L 180,130 Z M 180,140 L 220,140 L 220,160 L 180,160 Z;
                            M 140,170 L 260,170 L 260,190 L 140,190 Z M 140,200 L 260,200 L 260,220 L 140,220 Z M 140,230 L 260,230 L 260,250 L 140,250 Z
                        " />

                    <!-- Color transition: User space (pink) → Kernel space (blue) -->
                    <animate id="color-anim"
                        attributeName="fill"
                        begin="indefinite"
                        dur="3s"
                        fill="freeze"
                        values="#f093fb; #c77ef5; #4facfe; #4facfe" />

                    <!-- Glow intensity increases during split -->
                    <animate id="glow-anim"
                        attributeName="filter"
                        begin="indefinite"
                        dur="3s"
                        fill="freeze"
                        values="drop-shadow(0 0 10px #f093fb); drop-shadow(0 0 30px #c77ef5); drop-shadow(0 0 20px #4facfe); drop-shadow(0 0 15px #4facfe)" />

                    <!-- Vertical motion -->
                    <animateTransform id="motion-anim"
                        attributeName="transform"
                        type="translate"
                        begin="indefinite"
                        dur="3s"
                        fill="freeze"
                        values="0,0; 0,50; 0,150" />
                </path>

                <!-- Labels that follow the blob -->
                <g id="labels">
                    <!-- Stage 0: fd=3 -->
                    <text class="stage-label-text" x="200" y="45">
                        <animate attributeName="opacity" begin="indefinite" dur="3s" values="1;1;0" fill="freeze"/>
                        fd
                    </text>
                    <text class="stage-value-text" x="200" y="60">
                        <animate attributeName="opacity" begin="indefinite" dur="3s" values="1;1;0" fill="freeze"/>
                        3
                    </text>

                    <!-- Stage 1: Registers appear -->
                    <g opacity="0">
                        <animate attributeName="opacity" begin="indefinite" dur="3s" values="0;0;1" fill="freeze"/>
                        <text class="stage-value-text" x="200" y="185">RAX=0</text>
                        <text class="stage-value-text" x="200" y="215">RDI=3</text>
                        <text class="stage-value-text" x="200" y="245">RDX=4096</text>
                    </g>
                </g>
            </g>
        </svg>

        <div class="controls">
            <button onclick="startMorph()" id="play-btn">▶ Play Transformation</button>
            <button onclick="resetMorph()">⟲ Reset</button>
            <button onclick="nextStage()" id="next-btn" style="display:none">Next Stage →</button>
        </div>
    </div>

    <script>
        function startMorph() {
            // Start all animations
            const morphAnim = document.getElementById('morph-anim');
            const motionAnim = document.getElementById('motion-anim');
            const colorAnim = document.getElementById('color-anim');
            const glowAnim = document.getElementById('glow-anim');
            const allAnimates = document.querySelectorAll('#labels animate');

            morphAnim.beginElement();
            motionAnim.beginElement();
            colorAnim.beginElement();
            glowAnim.beginElement();
            allAnimates.forEach(a => a.beginElement());

            // Update explanation with precise timing
            const explanation = document.getElementById('explanation');
            const messages = [
                { time: 0, text: "Starting: A circle containing fd=3 in user space..." },
                { time: 900, text: "Elongating: Circle stretches as it enters kernel boundary..." },
                { time: 1800, text: "✨ SPLITTING: Watch the shape divide into three pieces!" },
                { time: 2600, text: "Complete: fd=3 has BECOME three CPU registers (RAX, RDI, RDX)!" }
            ];

            messages.forEach(msg => {
                setTimeout(() => { explanation.textContent = msg.text; }, msg.time);
            });

            // Show next stage button when complete
            setTimeout(() => {
                document.getElementById('next-btn').style.display = 'inline-block';
            }, 3000);
        }

        function resetMorph() {
            // Reload to reset SVG animations
            location.reload();
        }

        function nextStage() {
            // Switch to Stage 1→2
            document.querySelector('.stage-label').textContent = 'Stage 1→2: Registers to File Structure';
            document.getElementById('explanation').textContent = 'Watch three register bars converge and merge, then expand into a file structure tree.';

            // Clear current stage
            document.getElementById('stage-0-to-1').style.display = 'none';

            // Create Stage 1→2
            const svg = document.getElementById('stage-0-to-1').cloneNode(false);
            svg.setAttribute('id', 'stage-1-to-2');
            svg.innerHTML = `
                <!-- Stage markers -->
                <text x="50" y="80" fill="rgba(255,255,255,0.3)" font-size="10">KERNEL VFS LAYER</text>
                <line x1="0" y1="120" x2="400" y2="120" stroke="rgba(255,255,255,0.1)" stroke-width="1" stroke-dasharray="5,5"/>
                <text x="50" y="140" fill="rgba(255,255,255,0.3)" font-size="10">FILE STRUCTURE</text>

                <!-- The morphing data blob -->
                <g id="morphing-blob-2">
                    <!-- Path: Three bars → Merged → Tree structure -->
                    <path class="data-blob" id="morph-path-2" fill="#4facfe">
                        <!-- Shape morphing: Three bars → Converging → Merged → Tree -->
                        <animate id="morph-anim-2" attributeName="d"
                            begin="indefinite"
                            dur="4s"
                            fill="freeze"
                            keyTimes="0; 0.25; 0.5; 1"
                            values="
                                M 140,40 L 260,40 L 260,60 L 140,60 Z M 140,70 L 260,70 L 260,90 L 140,90 Z M 140,100 L 260,100 L 260,120 L 140,120 Z;
                                M 170,55 L 230,55 L 230,75 L 170,75 Z M 170,80 L 230,80 L 230,100 L 170,100 Z;
                                M 180,65 L 220,65 L 220,95 L 180,95 Z;
                                M 140,140 L 260,140 L 260,240 L 140,240 Z M 145,170 L 155,170 L 155,180 L 145,180 Z M 145,190 L 255,190 L 255,200 L 145,200 Z M 145,210 L 255,210 L 255,220 L 145,220 Z
                            " />

                        <!-- Glow intensifies at merge moment -->
                        <animate id="glow-anim-2"
                            attributeName="filter"
                            begin="indefinite"
                            dur="4s"
                            fill="freeze"
                            keyTimes="0; 0.5; 0.6; 1"
                            values="drop-shadow(0 0 15px #4facfe); drop-shadow(0 0 40px #43e97b); drop-shadow(0 0 25px #43e97b); drop-shadow(0 0 20px #43e97b)" />

                        <!-- Color shifts to green (file found) -->
                        <animate id="color-anim-2"
                            attributeName="fill"
                            begin="indefinite"
                            dur="4s"
                            fill="freeze"
                            keyTimes="0; 0.5; 1"
                            values="#4facfe; #3fd49d; #43e97b" />

                        <!-- Vertical motion -->
                        <animateTransform id="motion-anim-2"
                            attributeName="transform"
                            type="translate"
                            begin="indefinite"
                            dur="4s"
                            fill="freeze"
                            values="0,0; 0,40; 0,100" />
                    </path>

                    <!-- Labels -->
                    <g id="labels-2">
                        <!-- Initial: Register names -->
                        <g opacity="1">
                            <animate id="reg-fade" attributeName="opacity" begin="indefinite" dur="4s" keyTimes="0; 0.5; 1" values="1; 0; 0" fill="freeze"/>
                            <text class="stage-value-text" x="200" y="55" fill="#0a0e27">RAX=0</text>
                            <text class="stage-value-text" x="200" y="85" fill="#0a0e27">RDI=3</text>
                            <text class="stage-value-text" x="200" y="115" fill="#0a0e27">RDX=4096</text>
                        </g>

                        <!-- Final: File structure info -->
                        <g opacity="0">
                            <animate id="file-appear" attributeName="opacity" begin="indefinite" dur="4s" keyTimes="0; 0.6; 1" values="0; 0; 1" fill="freeze"/>
                            <animateTransform attributeName="transform" type="translate" values="0,0; 0,100" dur="4s" begin="indefinite" fill="freeze"/>
                            <text x="155" y="155" fill="#43e97b" font-size="8" font-weight="bold">file*</text>
                            <text x="155" y="200" fill="#0a0e27" font-size="7">/data.txt</text>
                            <text x="155" y="220" fill="#0a0e27" font-size="7">inode: 524288</text>
                        </g>
                    </g>
                </g>
            `;

            document.querySelector('.morph-stage').appendChild(svg);

            // Update controls for Stage 2
            document.querySelector('.controls').innerHTML = `
                <button onclick="startStage2()" id="play-btn-2">▶ Play Transformation</button>
                <button onclick="resetMorph()">⟲ Reset to Stage 1</button>
            `;
        }

        function startStage2() {
            const morphAnim = document.getElementById('morph-anim-2');
            const motionAnim = document.getElementById('motion-anim-2');
            const colorAnim = document.getElementById('color-anim-2');
            const glowAnim = document.getElementById('glow-anim-2');
            const regFade = document.getElementById('reg-fade');
            const fileAppear = document.getElementById('file-appear');
            const labelTransform = document.querySelector('#labels-2 > g:last-child animateTransform');

            [morphAnim, motionAnim, colorAnim, glowAnim, regFade, fileAppear, labelTransform].forEach(a => a.beginElement());

            const explanation = document.getElementById('explanation');
            const messages = [
                { time: 0, text: "Starting: Three CPU registers (RAX, RDI, RDX) holding parameters..." },
                { time: 1000, text: "Converging: Registers combine for VFS lookup..." },
                { time: 2000, text: "✨ LOOKUP: Finding file structure in fd table!" },
                { time: 3000, text: "Growing: File structure tree expands with metadata..." },
                { time: 3800, text: "Complete: Registers have BECOME file structure (/data.txt, inode 524288)!" }
            ];

            messages.forEach(msg => {
                setTimeout(() => { explanation.textContent = msg.text; }, msg.time);
            });

            // Update button
            setTimeout(() => {
                document.querySelector('.controls').innerHTML = `
                    <button onclick="location.reload()">⟲ Reset</button>
                    <button onclick="alert('Stages 2→3→4→5 continue the morphing flow...')">View All Stages →</button>
                `;
            }, 4000);
        }
    </script>
</body>
</html>
