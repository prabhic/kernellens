<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kernel Lens - Immersive Data Transformation Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8eaf6;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
            transition: all 0.5s;
        }

        .header.zoomed {
            opacity: 0.2;
            transform: scale(0.8);
        }

        .header h1 {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
            letter-spacing: -1px;
        }

        .header p {
            font-size: 14px;
            color: #9fa8da;
            font-weight: 400;
        }

        /* Control Panel */
        .controls {
            background: rgba(30, 37, 66, 0.6);
            border: 1px solid #283593;
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            transition: all 0.5s;
        }

        .controls.zoomed {
            opacity: 0.1;
            transform: scale(0.9);
            pointer-events: none;
        }

        .control-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-size: 12px;
            color: #9fa8da;
            font-weight: 600;
            white-space: nowrap;
        }

        .control-group select,
        .control-group input {
            background: #1e2542;
            border: 1px solid #3949ab;
            border-radius: 6px;
            padding: 6px 10px;
            color: #e8eaf6;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            outline: none;
            transition: all 0.2s;
        }

        .control-group select:focus,
        .control-group input:focus {
            border-color: #667eea;
        }

        .control-group input {
            width: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 20px;
            color: white;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        /* Main Visualization Area */
        .viz-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: visible;
        }

        /* Flow Container */
        .flow-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flow-stages {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
        }

        /* Backdrop when zoomed */
        .backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 10;
        }

        .backdrop.visible {
            opacity: 1;
            pointer-events: all;
        }

        /* Data Block - Compact by default */
        .data-block {
            background: linear-gradient(135deg, #1e2542 0%, #252d4a 100%);
            border: 2px solid #3949ab;
            border-radius: 12px;
            padding: 12px;
            width: 90px;
            min-height: 100px;
            position: relative;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            z-index: 1;
        }

        .data-block:hover:not(.zoomed) {
            transform: translateY(-8px) scale(1.08);
            border-color: #667eea;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5);
            z-index: 10;
        }

        .data-block.active:not(.zoomed) {
            border-color: #4caf50;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.8);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Zoomed state - MUCH LARGER with details inside */
        .data-block.zoomed {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) !important;
            width: 700px;
            max-width: 90vw;
            max-height: 85vh;
            overflow-y: auto;
            padding: 32px;
            border-color: #ffd700;
            box-shadow: 0 30px 100px rgba(255, 215, 0, 0.6);
            z-index: 100;
            cursor: default;
            text-align: left;
            animation: none;
        }

        /* Shrunk state (context blocks) */
        .data-block.shrunk {
            opacity: 0.12;
            transform: scale(0.5);
            filter: blur(2px);
            pointer-events: none;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 30px rgba(76, 175, 80, 0.8);
            }
            50% {
                box-shadow: 0 0 45px rgba(76, 175, 80, 1);
            }
        }

        /* Compact view elements */
        .compact-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.3s;
        }

        .data-block.zoomed .compact-view {
            display: none;
        }

        .data-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .data-label {
            font-size: 9px;
            color: #5c6bc0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .data-key-value {
            font-size: 11px;
            color: #4caf50;
            font-family: 'Courier New', monospace;
            font-weight: 700;
        }

        /* Detailed view - shown when zoomed */
        .detailed-view {
            display: none;
            opacity: 0;
            animation: fadeIn 0.5s forwards 0.3s;
        }

        .data-block.zoomed .detailed-view {
            display: block;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .detailed-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #3949ab;
        }

        .detailed-icon {
            font-size: 48px;
        }

        .detailed-title-group h3 {
            font-size: 26px;
            color: #ffd700;
            margin-bottom: 6px;
            font-weight: 700;
        }

        .detailed-title-group p {
            font-size: 14px;
            color: #9fa8da;
            line-height: 1.5;
        }

        .detailed-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .detailed-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #3949ab;
            border-radius: 8px;
            padding: 16px;
        }

        .detailed-section-title {
            font-size: 12px;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .detailed-field {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.6;
        }

        .detailed-field:last-child {
            margin-bottom: 0;
        }

        .detailed-field-key {
            color: #9fa8da;
            font-weight: 600;
        }

        .detailed-field-value {
            color: #4caf50;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            text-align: right;
        }

        .detailed-code {
            background: #0f0f23;
            border: 2px solid #283593;
            border-radius: 8px;
            padding: 16px;
            font-size: 13px;
            color: #e8eaf6;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            overflow-x: auto;
        }

        .detailed-code-title {
            font-size: 12px;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .close-zoom {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #667eea;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: #e8eaf6;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .data-block.zoomed .close-zoom {
            opacity: 1;
        }

        .close-zoom:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.15);
        }

        /* Transformation Arrow */
        .transform-arrow {
            position: relative;
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, #3949ab 0%, #5c6bc0 100%);
            opacity: 0.4;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            z-index: 1;
        }

        .transform-arrow.shrunk {
            opacity: 0.05;
            transform: scale(0.5);
        }

        .transform-arrow.active {
            opacity: 1;
            background: linear-gradient(90deg, #667eea 0%, #4caf50 100%);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
            height: 3px;
        }

        .transform-arrow::after {
            content: '';
            position: absolute;
            right: -6px;
            top: -3px;
            width: 0;
            height: 0;
            border-left: 6px solid #5c6bc0;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            transition: all 0.4s;
        }

        .transform-arrow.active::after {
            border-left-color: #4caf50;
        }

        .transform-label {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            font-size: 8px;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            white-space: nowrap;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }

        .transform-arrow:hover .transform-label {
            opacity: 1;
        }

        .transform-arrow.active .transform-label {
            opacity: 1;
            color: #4caf50;
        }

        /* Flow Particles */
        .flow-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #4caf50;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.9);
            opacity: 0;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .transform-arrow.active .flow-particle {
            animation: particle-flow 1.5s ease-in-out infinite;
        }

        @keyframes particle-flow {
            0% {
                opacity: 0;
                left: 0;
            }
            20% {
                opacity: 1;
            }
            80% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                left: 100%;
            }
        }

        .flow-particle:nth-child(2) {
            animation-delay: 0.5s;
        }

        /* Helper text */
        .helper-text {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #9fa8da;
            opacity: 0.6;
            transition: all 0.5s;
            z-index: 5;
        }

        .helper-text.hidden {
            opacity: 0;
        }

        /* Scrollbar styling for zoomed view */
        .data-block.zoomed::-webkit-scrollbar {
            width: 8px;
        }

        .data-block.zoomed::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .data-block.zoomed::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        .data-block.zoomed::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .flow-stages {
                flex-wrap: wrap;
                gap: 20px;
            }

            .transform-arrow {
                display: none;
            }

            .data-block.zoomed {
                width: 600px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 28px;
            }

            .control-row {
                flex-direction: column;
                gap: 12px;
            }

            .data-block {
                width: 80px;
                min-height: 90px;
            }

            .data-block.zoomed {
                width: 95vw;
                padding: 24px;
            }

            .detailed-header {
                flex-direction: column;
                text-align: center;
            }

            .detailed-sections {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="backdrop" id="backdrop" onclick="closeZoom()"></div>

    <div class="container">
        <div class="header" id="header">
            <h1>üîç Kernel Lens</h1>
            <p>Click any stage to zoom in and explore</p>
        </div>

        <div class="controls" id="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>System Call:</label>
                    <select id="syscall">
                        <option value="read">read()</option>
                        <option value="write">write()</option>
                        <option value="open">open()</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>File Descriptor:</label>
                    <input type="number" id="fd" value="3" min="0" max="1024">
                </div>

                <div class="control-group">
                    <label>Buffer Size:</label>
                    <input type="number" id="size" value="4096" min="1" max="1048576">
                </div>

                <div class="control-group">
                    <label>Cache:</label>
                    <select id="cache">
                        <option value="hot">Hot (85% hit)</option>
                        <option value="cold">Cold (15% hit)</option>
                    </select>
                </div>

                <button class="btn" onclick="executeFlow()">‚ñ∂ Execute</button>
            </div>
        </div>

        <div class="viz-area">
            <div class="flow-container">
                <div class="flow-stages" id="flowStages">
                    <!-- Stages will be generated by JS -->
                </div>
            </div>
        </div>

        <div class="helper-text" id="helperText">Click any block to zoom in ‚Ä¢ Press ESC or click outside to zoom out</div>
    </div>

    <script>
        const stageData = [
            {
                icon: 'üë§',
                label: 'User',
                keyValue: 'fd:3',
                keyValueId: 'user-fd-compact',
                title: 'User Space Input',
                description: 'Application initiates system call with parameters from user space (Ring 3). The parameters are validated and prepared for transition to kernel mode.',
                sections: {
                    'Parameters': [
                        { key: 'File Descriptor', value: '3', dynamic: 'fd' },
                        { key: 'Buffer Pointer', value: '0x7fff00001000' },
                        { key: 'Size', value: '4096 bytes', dynamic: 'size' }
                    ],
                    'Context': [
                        { key: 'Ring Level', value: '3 (User)' },
                        { key: 'Process ID', value: '1234' },
                        { key: 'CPU Mode', value: 'User mode' }
                    ]
                },
                code: 'ssize_t bytes = read(fd, buffer, count);\n// Application calls libc wrapper\n// Parameters pushed to registers'
            },
            {
                icon: 'üö™',
                label: 'Kernel',
                keyValue: 'ring:0',
                title: 'System Call Interface',
                description: 'CPU transitions from Ring 3 (user) to Ring 0 (kernel) via SYSCALL instruction. The system call table is consulted to dispatch to the correct handler.',
                sections: {
                    'Transition': [
                        { key: 'System Call', value: 'read (syscall #0)' },
                        { key: 'Ring Switch', value: '3 ‚Üí 0' },
                        { key: 'Mode', value: 'Kernel mode' }
                    ],
                    'Execution': [
                        { key: 'Handler', value: 'sys_read()' },
                        { key: 'Time', value: '~1Œºs' },
                        { key: 'Context Switches', value: '+1' }
                    ]
                },
                code: 'SYSCALL_DEFINE3(read, unsigned int, fd,\n    char __user *, buf, size_t, count)\n{\n    // Kernel mode entry point\n}'
            },
            {
                icon: 'üìÇ',
                label: 'File',
                keyValue: '/etc/‚Ä¶',
                title: 'File Object (VFS)',
                description: 'Virtual File System resolves the file descriptor from the process file descriptor table to obtain the file structure pointer and inode.',
                sections: {
                    'Resolution': [
                        { key: 'FD Lookup', value: 'fdget_pos(3)' },
                        { key: 'File Path', value: '/etc/passwd' },
                        { key: 'Dentry Cache', value: 'HIT' }
                    ],
                    'File Info': [
                        { key: 'Inode', value: '524288' },
                        { key: 'Mode', value: 'r-- (read-only)' },
                        { key: 'Position', value: '0' }
                    ]
                },
                code: 'struct file *file = fdt->fd[fd];\nstruct inode *inode = file->f_inode;\nif (!file_permission(file, MAY_READ))\n    return -EACCES;'
            },
            {
                icon: 'üíæ',
                label: 'Inode',
                keyValue: 'HIT',
                keyValueId: 'cache-status-compact',
                title: 'Inode & Blocks (ext4)',
                description: 'Filesystem layer maps logical file blocks to physical disk blocks using extent trees. Page cache is checked for existing data before issuing disk I/O.',
                sections: {
                    'Inode': [
                        { key: 'Inode Number', value: '524288' },
                        { key: 'Block Count', value: '8 blocks' },
                        { key: 'File System', value: 'ext4' }
                    ],
                    'Mapping': [
                        { key: 'Logical Block', value: '0' },
                        { key: 'Physical Block', value: '12345678' },
                        { key: 'Extent', value: 'ext[0]: 8 blocks' }
                    ],
                    'Cache': [
                        { key: 'Page Cache', value: 'HIT (85%)', dynamic: 'cache' },
                        { key: 'Pages Cached', value: '6/8 blocks' },
                        { key: 'Cache Time', value: '<1Œºs' }
                    ]
                },
                code: 'page = find_get_page(mapping, index);\nif (!page) {\n    // Cache miss - need disk I/O\n    submit_bio(READ, bio);\n} else {\n    // Cache hit - use cached data\n}'
            },
            {
                icon: '‚öôÔ∏è',
                label: 'I/O',
                keyValue: '1 op',
                keyValueId: 'io-ops-compact',
                title: 'Block I/O Layer',
                description: 'Block device I/O scheduler organizes and optimizes disk requests. The BIO (block I/O) structure is created and queued for the device driver.',
                sections: {
                    'Request': [
                        { key: 'Sector', value: '24576' },
                        { key: 'Operations', value: '1 read', dynamic: 'ioOps' },
                        { key: 'Size', value: '4096 bytes' }
                    ],
                    'Scheduling': [
                        { key: 'Scheduler', value: 'mq-deadline' },
                        { key: 'Queue Depth', value: '12/32' },
                        { key: 'Wait Time', value: '~10Œºs' }
                    ]
                },
                code: 'struct bio *bio = bio_alloc(sector, size);\nbio->bi_bdev = bdev;\nbio->bi_opf = READ;\nsubmit_bio(bio);'
            },
            {
                icon: 'üì¶',
                label: 'Data',
                keyValue: '4KB',
                keyValueId: 'data-bytes-compact',
                title: 'Raw Data',
                description: 'File content is retrieved from storage device via DMA transfer. Data is validated and prepared for copying to user space buffer.',
                sections: {
                    'Data': [
                        { key: 'Bytes Read', value: '4096', dynamic: 'sizeDisplay' },
                        { key: 'Content', value: 'root:x:0:0:root...' },
                        { key: 'Validation', value: '‚úì Valid' }
                    ],
                    'Transfer': [
                        { key: 'DMA Active', value: 'Yes' },
                        { key: 'Memory Addr', value: '0xffff88001234000' },
                        { key: 'IRQ', value: '45 (complete)' }
                    ]
                },
                code: 'copy_to_user(buf, page_address(page), count);\n// Safe copy from kernel to user space\n// Validates user buffer accessibility'
            },
            {
                icon: '‚Ü©Ô∏è',
                label: 'Result',
                keyValue: '125Œºs',
                keyValueId: 'result-time-compact',
                title: 'Return to User',
                description: 'Data is copied to user space buffer. CPU transitions back to Ring 3 and returns control to the application with the read count.',
                sections: {
                    'Result': [
                        { key: 'Return Value', value: '4096 bytes', dynamic: 'sizeBytes' },
                        { key: 'Error Code', value: '0 (Success)' },
                        { key: 'Total Time', value: '125Œºs', dynamic: 'timeStr' }
                    ],
                    'Transition': [
                        { key: 'Ring Switch', value: '0 ‚Üí 3' },
                        { key: 'CPU Mode', value: 'Back to user' },
                        { key: 'Instruction', value: 'SYSRET' }
                    ]
                },
                code: 'return count; // Returns to userspace\n// SYSRET instruction switches to Ring 3\n// Application continues execution'
            }
        ];

        let currentStage = -1;
        let zoomedStage = null;
        let animationInterval = null;

        function init() {
            renderStages();
            updateParameters();
            setTimeout(executeFlow, 500);
        }

        function renderStages() {
            const container = document.getElementById('flowStages');
            let html = '';

            stageData.forEach((stage, i) => {
                // Build sections HTML
                let sectionsHTML = '';
                for (const [sectionName, fields] of Object.entries(stage.sections)) {
                    sectionsHTML += `
                        <div class="detailed-section">
                            <div class="detailed-section-title">${sectionName}</div>
                            ${fields.map(f => `
                                <div class="detailed-field">
                                    <span class="detailed-field-key">${f.key}:</span>
                                    <span class="detailed-field-value">${f.value}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Add data block
                html += `
                    <div class="data-block" data-stage="${i}" onclick="zoomIn(${i})">
                        <div class="close-zoom" onclick="event.stopPropagation(); closeZoom();">‚úï</div>

                        <!-- Compact view (default) -->
                        <div class="compact-view">
                            <div class="data-icon">${stage.icon}</div>
                            <div class="data-label">${stage.label}</div>
                            <div class="data-key-value" ${stage.keyValueId ? `id="${stage.keyValueId}"` : ''}>${stage.keyValue}</div>
                        </div>

                        <!-- Detailed view (when zoomed) -->
                        <div class="detailed-view">
                            <div class="detailed-header">
                                <div class="detailed-icon">${stage.icon}</div>
                                <div class="detailed-title-group">
                                    <h3>${stage.title}</h3>
                                    <p>${stage.description}</p>
                                </div>
                            </div>
                            <div class="detailed-sections">
                                ${sectionsHTML}
                            </div>
                            <div class="detailed-code-title">Kernel Code</div>
                            <div class="detailed-code">${stage.code}</div>
                        </div>
                    </div>
                `;

                // Add arrow (except after last block)
                if (i < stageData.length - 1) {
                    html += `
                        <div class="transform-arrow" data-arrow="${i}">
                            <div class="transform-label">${['SYSCALL', 'VFS', 'FS', 'BLOCK', 'DMA', 'RETURN'][i]}</div>
                            <div class="flow-particle"></div>
                            <div class="flow-particle"></div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        function updateParameters() {
            const fd = document.getElementById('fd').value;
            const size = document.getElementById('size').value;
            const cache = document.getElementById('cache').value;

            // Update compact display
            const userFdEl = document.getElementById('user-fd-compact');
            if (userFdEl) userFdEl.textContent = `fd:${fd}`;

            const cacheStatusEl = document.getElementById('cache-status-compact');
            if (cacheStatusEl) cacheStatusEl.textContent = cache === 'hot' ? 'HIT' : 'MISS';

            const ioOps = cache === 'hot' ? 0 : Math.ceil(size / 4096);
            const ioOpsEl = document.getElementById('io-ops-compact');
            if (ioOpsEl) ioOpsEl.textContent = ioOps === 0 ? 'cached' : `${ioOps} op${ioOps > 1 ? 's' : ''}`;

            const sizeKB = size >= 1024 ? (size / 1024).toFixed(0) + 'KB' : size + 'B';
            const dataBytesEl = document.getElementById('data-bytes-compact');
            if (dataBytesEl) dataBytesEl.textContent = sizeKB;

            const baseTime = 125;
            const diskTime = cache === 'hot' ? 0 : ioOps * 8000;
            const totalTime = baseTime + diskTime;
            const timeStr = totalTime < 1000 ? totalTime + 'Œºs' : (totalTime / 1000).toFixed(1) + 'ms';
            const resultTimeEl = document.getElementById('result-time-compact');
            if (resultTimeEl) resultTimeEl.textContent = timeStr;
        }

        function zoomIn(stage) {
            if (zoomedStage !== null) return; // Already zoomed

            zoomedStage = stage;

            // Show backdrop
            document.getElementById('backdrop').classList.add('visible');

            // Dim header and controls
            document.getElementById('header').classList.add('zoomed');
            document.getElementById('controls').classList.add('zoomed');

            // Hide helper text
            document.getElementById('helperText').classList.add('hidden');

            // Zoom selected block
            const selectedBlock = document.querySelector(`[data-stage="${stage}"]`);
            selectedBlock.classList.add('zoomed');
            selectedBlock.classList.remove('active'); // Remove animation

            // Shrink other blocks
            document.querySelectorAll('.data-block').forEach((block, i) => {
                if (i !== stage) {
                    block.classList.add('shrunk');
                }
            });

            // Shrink arrows
            document.querySelectorAll('.transform-arrow').forEach(arrow => {
                arrow.classList.add('shrunk');
            });
        }

        function closeZoom() {
            if (zoomedStage === null) return;

            // Hide backdrop
            document.getElementById('backdrop').classList.remove('visible');

            // Restore header and controls
            document.getElementById('header').classList.remove('zoomed');
            document.getElementById('controls').classList.remove('zoomed');

            // Show helper text
            document.getElementById('helperText').classList.remove('hidden');

            // Un-zoom selected block
            const selectedBlock = document.querySelector(`[data-stage="${zoomedStage}"]`);
            selectedBlock.classList.remove('zoomed');

            // Un-shrink other blocks
            document.querySelectorAll('.data-block').forEach(block => {
                block.classList.remove('shrunk');
            });

            // Un-shrink arrows
            document.querySelectorAll('.transform-arrow').forEach(arrow => {
                arrow.classList.remove('shrunk');
            });

            zoomedStage = null;
        }

        function executeFlow() {
            // Close zoom if open
            if (zoomedStage !== null) {
                closeZoom();
            }

            // Stop any existing animation
            if (animationInterval) {
                clearInterval(animationInterval);
            }

            // Reset all stages
            document.querySelectorAll('.data-block').forEach(block => {
                block.classList.remove('active');
            });
            document.querySelectorAll('.transform-arrow').forEach(arrow => {
                arrow.classList.remove('active');
            });

            // Update parameters
            updateParameters();

            // Start animation
            currentStage = -1;
            animateNextStage();
        }

        function animateNextStage() {
            // Remove active class from previous stage
            if (currentStage >= 0) {
                const prevBlock = document.querySelector(`[data-stage="${currentStage}"]`);
                if (prevBlock && !prevBlock.classList.contains('zoomed')) {
                    prevBlock.classList.remove('active');
                }
                if (currentStage > 0) {
                    const prevArrow = document.querySelector(`[data-arrow="${currentStage - 1}"]`);
                    if (prevArrow) {
                        prevArrow.classList.remove('active');
                    }
                }
            }

            // Move to next stage
            currentStage++;

            if (currentStage < stageData.length) {
                // Activate current arrow
                if (currentStage > 0) {
                    const arrow = document.querySelector(`[data-arrow="${currentStage - 1}"]`);
                    if (arrow) {
                        arrow.classList.add('active');
                    }
                }

                // Activate current block
                const currentBlock = document.querySelector(`[data-stage="${currentStage}"]`);
                if (currentBlock && !currentBlock.classList.contains('zoomed')) {
                    currentBlock.classList.add('active');
                }

                // Schedule next stage
                animationInterval = setTimeout(animateNextStage, 800);
            } else {
                // Animation complete
                const lastBlock = document.querySelector(`[data-stage="${stageData.length - 1}"]`);
                if (lastBlock && !lastBlock.classList.contains('zoomed')) {
                    lastBlock.classList.add('active');
                }
            }
        }

        // ESC key to close zoom
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && zoomedStage !== null) {
                closeZoom();
            }
        });

        // Update parameters when changed
        ['fd', 'size', 'cache', 'syscall'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', updateParameters);
            }
        });

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
