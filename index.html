<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kernel Lens - Visualizing Kernel Execution</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            background: #f8f9fa;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            font-size: 0.9em;
            color: #495057;
        }

        select, button {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .main-content {
            padding: 30px;
        }

        .info-panel {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .info-panel h3 {
            color: #0066cc;
            margin-bottom: 5px;
        }

        .visualization {
            position: relative;
            min-height: 600px;
            background: #fafbfc;
            border-radius: 12px;
            padding: 30px;
            overflow-x: auto;
        }

        /* Flow Stages */
        .flow-container {
            display: flex;
            flex-direction: column;
            gap: 40px;
            position: relative;
        }

        .stage {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s;
        }

        .stage:hover {
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
            transform: translateX(5px);
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .stage-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stage-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .expand-icon {
            font-size: 1.2em;
            color: #6c757d;
            transition: transform 0.3s;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .stage-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .stage-content.expanded {
            max-height: 2000px;
        }

        .stage-description {
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* Data Flow Visualization */
        .data-flow {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            position: relative;
        }

        .flow-box {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            min-width: 150px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
        }

        .flow-box:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .flow-box.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .flow-arrow {
            font-size: 1.5em;
            color: #667eea;
            font-weight: 700;
            animation: slide 1.5s infinite;
        }

        @keyframes slide {
            0%, 100% { transform: translateX(0); opacity: 0.5; }
            50% { transform: translateX(5px); opacity: 1; }
        }

        .flow-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .flow-value {
            font-size: 1.1em;
            font-weight: 700;
            color: #2c3e50;
        }

        .flow-box.active .flow-label,
        .flow-box.active .flow-value {
            color: white;
        }

        /* Metrics and Details */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-card.kernel-mode {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .metric-card.memory {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .metric-card.cpu {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
        }

        /* Code Block */
        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 10px 0;
        }

        .code-block .keyword {
            color: #c678dd;
        }

        .code-block .function {
            color: #61afef;
        }

        .code-block .string {
            color: #98c379;
        }

        .code-block .comment {
            color: #5c6370;
            font-style: italic;
        }

        /* Connection Lines */
        .connection-line {
            position: absolute;
            width: 2px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            left: 50%;
            transform: translateX(-50%);
            z-index: -1;
        }

        /* Animation States */
        .stage.executing {
            border: 2px solid #667eea;
            background: linear-gradient(to right, #f8f9ff 0%, white 100%);
        }

        .stage.completed {
            opacity: 0.7;
        }

        /* Timeline */
        .timeline {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            align-items: center;
        }

        .timeline-step {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            position: relative;
            transition: all 0.3s;
        }

        .timeline-step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .timeline-step.completed {
            background: #28a745;
        }

        .timeline-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: #6c757d;
            white-space: nowrap;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-label {
            font-size: 0.9em;
            color: #495057;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .data-flow {
                flex-direction: column;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Kernel Lens</h1>
            <p>Interactive Visualization of Kernel Internal Execution</p>
        </header>

        <div class="controls">
            <div class="control-group">
                <label>Select System Call</label>
                <select id="syscall-select">
                    <option value="read">read() - File Read Operation</option>
                    <option value="write">write() - File Write Operation</option>
                    <option value="open">open() - File Open Operation</option>
                    <option value="fork">fork() - Process Creation</option>
                </select>
            </div>
            <button id="start-btn">‚ñ∂ Start Visualization</button>
            <button id="step-btn">‚è≠ Step Through</button>
            <button id="reset-btn">‚Üª Reset</button>
        </div>

        <div class="main-content">
            <div class="info-panel">
                <h3>Sequence: read() System Call Execution</h3>
                <p>Follow the journey of a read() system call from user space through kernel space and back. Click on each stage to expand and explore the internal operations.</p>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                    <span class="legend-label">Currently Executing</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #28a745;"></div>
                    <span class="legend-label">Completed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #e9ecef;"></div>
                    <span class="legend-label">Pending</span>
                </div>
            </div>

            <div class="timeline" id="timeline">
                <div class="timeline-step" data-stage="0">
                    <span class="timeline-label">User Space</span>
                </div>
                <div class="timeline-step" data-stage="1">
                    <span class="timeline-label">System Call</span>
                </div>
                <div class="timeline-step" data-stage="2">
                    <span class="timeline-label">VFS Layer</span>
                </div>
                <div class="timeline-step" data-stage="3">
                    <span class="timeline-label">File System</span>
                </div>
                <div class="timeline-step" data-stage="4">
                    <span class="timeline-label">Block Layer</span>
                </div>
                <div class="timeline-step" data-stage="5">
                    <span class="timeline-label">Return</span>
                </div>
            </div>

            <div class="visualization">
                <div class="flow-container" id="flow-container">
                    <!-- Stages will be dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Kernel execution data model
        const kernelSequences = {
            read: {
                name: "read() - File Read Operation",
                description: "Reading data from a file descriptor",
                stages: [
                    {
                        title: "User Space - Application Layer",
                        description: "Application invokes read() system call to read data from a file",
                        flows: [
                            { label: "File Descriptor", value: "fd=3" },
                            { label: "Buffer", value: "*buf" },
                            { label: "Count", value: "1024 bytes" }
                        ],
                        code: `<span class="comment">// User application code</span>
<span class="keyword">char</span> buffer[<span class="string">1024</span>];
<span class="keyword">int</span> fd = <span class="function">open</span>(<span class="string">"/etc/passwd"</span>, O_RDONLY);
<span class="keyword">ssize_t</span> bytes = <span class="function">read</span>(fd, buffer, <span class="keyword">sizeof</span>(buffer));`,
                        metrics: [
                            { label: "Process ID", value: "1234", type: "cpu" },
                            { label: "Mode", value: "User", type: "kernel-mode" }
                        ]
                    },
                    {
                        title: "System Call Interface",
                        description: "Transition from user space to kernel space via system call trap",
                        flows: [
                            { label: "Syscall Number", value: "SYS_read (0)" },
                            { label: "CPU Mode", value: "User ‚Üí Kernel" },
                            { label: "Privilege Level", value: "Ring 3 ‚Üí Ring 0" }
                        ],
                        code: `<span class="comment">// System call entry point</span>
<span class="function">SYSCALL_DEFINE3</span>(read, <span class="keyword">unsigned int</span>, fd,
                <span class="keyword">char __user *</span>, buf,
                <span class="keyword">size_t</span>, count) {
    <span class="keyword">return</span> <span class="function">ksys_read</span>(fd, buf, count);
}`,
                        metrics: [
                            { label: "Context Switch", value: "1Œºs", type: "cpu" },
                            { label: "Mode", value: "Kernel", type: "kernel-mode" }
                        ]
                    },
                    {
                        title: "Virtual File System (VFS)",
                        description: "VFS layer resolves file descriptor to file structure and determines appropriate file operations",
                        flows: [
                            { label: "FD Table", value: "fd ‚Üí file*" },
                            { label: "File Structure", value: "struct file" },
                            { label: "Operations", value: "f_op->read" }
                        ],
                        code: `<span class="comment">// VFS read operation</span>
<span class="keyword">ssize_t</span> <span class="function">ksys_read</span>(<span class="keyword">unsigned int</span> fd, <span class="keyword">char __user *</span>buf, <span class="keyword">size_t</span> count) {
    <span class="keyword">struct</span> fd f = <span class="function">fdget_pos</span>(fd);
    <span class="keyword">if</span> (f.file) {
        <span class="keyword">ssize_t</span> ret = <span class="function">vfs_read</span>(f.file, buf, count, &pos);
        <span class="function">fdput_pos</span>(f);
        <span class="keyword">return</span> ret;
    }
}`,
                        metrics: [
                            { label: "Inode", value: "i:524288", type: "memory" },
                            { label: "Dentry Cache", value: "Hit", type: "kernel-mode" }
                        ]
                    },
                    {
                        title: "File System Layer",
                        description: "File system specific read operation (ext4, xfs, etc.) processes the request",
                        flows: [
                            { label: "FS Type", value: "ext4" },
                            { label: "Block Map", value: "logical ‚Üí physical" },
                            { label: "Page Cache", value: "Check cache" }
                        ],
                        code: `<span class="comment">// ext4 file system read</span>
<span class="keyword">static ssize_t</span> <span class="function">ext4_file_read_iter</span>(<span class="keyword">struct</span> kiocb *iocb,
                                    <span class="keyword">struct</span> iov_iter *to) {
    <span class="comment">// Check page cache first</span>
    <span class="keyword">if</span> (<span class="function">page_cache_hit</span>()) {
        <span class="keyword">return</span> <span class="function">generic_file_read_iter</span>(iocb, to);
    }
    <span class="comment">// Cache miss - read from disk</span>
    <span class="keyword">return</span> <span class="function">ext4_direct_IO</span>(iocb, to);
}`,
                        metrics: [
                            { label: "Block Size", value: "4096B", type: "memory" },
                            { label: "Cache Hit", value: "85%", type: "kernel-mode" }
                        ]
                    },
                    {
                        title: "Block Layer & Device Driver",
                        description: "Block I/O layer prepares request and device driver executes physical read from storage",
                        flows: [
                            { label: "Block Request", value: "submit_bio()" },
                            { label: "I/O Scheduler", value: "mq-deadline" },
                            { label: "Device", value: "/dev/sda" }
                        ],
                        code: `<span class="comment">// Block layer I/O submission</span>
<span class="keyword">void</span> <span class="function">submit_bio</span>(<span class="keyword">struct</span> bio *bio) {
    <span class="comment">// Add to I/O scheduler queue</span>
    <span class="function">blk_mq_submit_bio</span>(bio);

    <span class="comment">// Wait for DMA transfer</span>
    <span class="keyword">struct</span> request *rq = <span class="function">blk_mq_get_request</span>();
    <span class="function">blk_execute_rq</span>(rq);
}`,
                        metrics: [
                            { label: "I/O Size", value: "4KB", type: "memory" },
                            { label: "Latency", value: "150Œºs", type: "cpu" },
                            { label: "Queue Depth", value: "32", type: "kernel-mode" }
                        ]
                    },
                    {
                        title: "Return to User Space",
                        description: "Data copied to user buffer and control returns to application",
                        flows: [
                            { label: "Data Copy", value: "kernel ‚Üí user" },
                            { label: "Return Value", value: "1024 bytes" },
                            { label: "CPU Mode", value: "Kernel ‚Üí User" }
                        ],
                        code: `<span class="comment">// Return from system call</span>
<span class="keyword">ssize_t</span> ret = <span class="function">copy_to_user</span>(buf, kernel_buf, count);

<span class="comment">// Restore user context and return</span>
<span class="function">syscall_exit</span>();
<span class="keyword">return</span> count; <span class="comment">// bytes read</span>`,
                        metrics: [
                            { label: "Bytes Read", value: "1024", type: "memory" },
                            { label: "Total Time", value: "175Œºs", type: "cpu" },
                            { label: "Mode", value: "User", type: "kernel-mode" }
                        ]
                    }
                ]
            }
        };

        // Application state
        let currentSequence = 'read';
        let currentStage = 0;
        let isPlaying = false;
        let playInterval = null;

        // DOM elements
        const flowContainer = document.getElementById('flow-container');
        const startBtn = document.getElementById('start-btn');
        const stepBtn = document.getElementById('step-btn');
        const resetBtn = document.getElementById('reset-btn');
        const syscallSelect = document.getElementById('syscall-select');
        const timeline = document.getElementById('timeline');

        // Initialize visualization
        function init() {
            renderStages();
            updateTimeline();
        }

        // Render all stages
        function renderStages() {
            const sequence = kernelSequences[currentSequence];
            flowContainer.innerHTML = '';

            sequence.stages.forEach((stage, index) => {
                const stageEl = createStageElement(stage, index);
                flowContainer.appendChild(stageEl);
            });
        }

        // Create stage element
        function createStageElement(stage, index) {
            const stageDiv = document.createElement('div');
            stageDiv.className = 'stage';
            stageDiv.dataset.stage = index;

            // Header
            const header = document.createElement('div');
            header.className = 'stage-header';
            header.innerHTML = `
                <div class="stage-title">
                    <div class="stage-number">${index + 1}</div>
                    <span>${stage.title}</span>
                </div>
                <div class="expand-icon">‚ñº</div>
            `;
            header.onclick = () => toggleStage(index);

            // Content
            const content = document.createElement('div');
            content.className = 'stage-content';

            const description = document.createElement('p');
            description.className = 'stage-description';
            description.textContent = stage.description;

            // Data flows
            const flowDiv = document.createElement('div');
            flowDiv.className = 'data-flow';
            stage.flows.forEach((flow, i) => {
                if (i > 0) {
                    const arrow = document.createElement('div');
                    arrow.className = 'flow-arrow';
                    arrow.textContent = '‚Üí';
                    flowDiv.appendChild(arrow);
                }
                const box = document.createElement('div');
                box.className = 'flow-box';
                box.innerHTML = `
                    <div class="flow-label">${flow.label}</div>
                    <div class="flow-value">${flow.value}</div>
                `;
                flowDiv.appendChild(box);
            });

            // Code block
            const codeBlock = document.createElement('div');
            codeBlock.className = 'code-block';
            codeBlock.innerHTML = stage.code;

            // Metrics
            const metricsGrid = document.createElement('div');
            metricsGrid.className = 'metrics-grid';
            stage.metrics.forEach(metric => {
                const card = document.createElement('div');
                card.className = `metric-card ${metric.type}`;
                card.innerHTML = `
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value">${metric.value}</div>
                `;
                metricsGrid.appendChild(card);
            });

            content.appendChild(description);
            content.appendChild(flowDiv);
            content.appendChild(codeBlock);
            content.appendChild(metricsGrid);

            stageDiv.appendChild(header);
            stageDiv.appendChild(content);

            return stageDiv;
        }

        // Toggle stage expansion
        function toggleStage(index) {
            const stageEl = document.querySelector(`.stage[data-stage="${index}"]`);
            const content = stageEl.querySelector('.stage-content');
            const icon = stageEl.querySelector('.expand-icon');

            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        // Start visualization
        function startVisualization() {
            if (isPlaying) {
                stopVisualization();
                return;
            }

            isPlaying = true;
            startBtn.textContent = '‚è∏ Pause';
            currentStage = 0;

            playInterval = setInterval(() => {
                executeStage(currentStage);
                currentStage++;

                if (currentStage >= kernelSequences[currentSequence].stages.length) {
                    stopVisualization();
                    currentStage = kernelSequences[currentSequence].stages.length - 1;
                }
            }, 2000);
        }

        // Stop visualization
        function stopVisualization() {
            isPlaying = false;
            startBtn.textContent = '‚ñ∂ Start Visualization';
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
        }

        // Execute single stage
        function executeStage(index) {
            // Update stages
            document.querySelectorAll('.stage').forEach((stage, i) => {
                stage.classList.remove('executing', 'completed');
                if (i < index) {
                    stage.classList.add('completed');
                } else if (i === index) {
                    stage.classList.add('executing');
                    // Auto-expand current stage
                    const content = stage.querySelector('.stage-content');
                    const icon = stage.querySelector('.expand-icon');
                    if (!content.classList.contains('expanded')) {
                        content.classList.add('expanded');
                        icon.classList.add('expanded');
                    }
                    // Scroll into view
                    stage.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Activate flow boxes
                    const flowBoxes = stage.querySelectorAll('.flow-box');
                    flowBoxes.forEach((box, boxIndex) => {
                        setTimeout(() => {
                            box.classList.add('active');
                        }, boxIndex * 300);
                    });
                }
            });

            updateTimeline();
        }

        // Update timeline
        function updateTimeline() {
            const steps = timeline.querySelectorAll('.timeline-step');
            steps.forEach((step, i) => {
                step.classList.remove('active', 'completed');
                if (i < currentStage) {
                    step.classList.add('completed');
                } else if (i === currentStage) {
                    step.classList.add('active');
                }
            });
        }

        // Step through
        function stepThrough() {
            if (currentStage < kernelSequences[currentSequence].stages.length) {
                executeStage(currentStage);
                currentStage++;
            }
        }

        // Reset visualization
        function reset() {
            stopVisualization();
            currentStage = 0;
            document.querySelectorAll('.stage').forEach(stage => {
                stage.classList.remove('executing', 'completed');
                stage.querySelector('.stage-content').classList.remove('expanded');
                stage.querySelector('.expand-icon').classList.remove('expanded');
                stage.querySelectorAll('.flow-box').forEach(box => {
                    box.classList.remove('active');
                });
            });
            updateTimeline();
        }

        // Change system call
        function changeSystemCall() {
            currentSequence = syscallSelect.value;
            reset();
            renderStages();
        }

        // Event listeners
        startBtn.onclick = startVisualization;
        stepBtn.onclick = stepThrough;
        resetBtn.onclick = reset;
        syscallSelect.onchange = changeSystemCall;

        // Initialize on load
        init();
    </script>
</body>
</html>
