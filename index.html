<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kernel Lens - Interactive Kernel Execution Visualizer</title>
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151a35;
            --bg-tertiary: #1e2542;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --text-primary: #e8eaf6;
            --text-secondary: #9fa8da;
            --text-muted: #5c6bc0;
            --border: #283593;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;

            /* Layer colors */
            --layer-user: #f093fb;
            --layer-syscall: #4facfe;
            --layer-vfs: #43e97b;
            --layer-fs: #fa709a;
            --layer-block: #fee140;
            --layer-device: #30cfd0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        }

        header h1 {
            font-size: 3em;
            color: white;
            margin-bottom: 10px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        header p {
            color: rgba(255,255,255,0.95);
            font-size: 1.2em;
            font-weight: 300;
        }

        /* Control Panel */
        .control-panel {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="number"], input[type="text"] {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1em;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        select:hover, input:hover {
            border-color: var(--accent-primary);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 14px 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Main Layout - Three Column */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Left Sidebar - Layer Navigator */
        .layer-navigator {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .nav-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            border-left-color: currentColor;
            box-shadow: 0 0 15px currentColor;
        }

        .nav-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: currentColor;
            transition: all 0.3s;
        }

        .nav-item.active .nav-indicator {
            animation: pulse-indicator 1.5s infinite;
        }

        @keyframes pulse-indicator {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }

        .nav-label {
            flex: 1;
            font-size: 0.9em;
            font-weight: 600;
        }

        .nav-time {
            font-size: 0.75em;
            font-family: 'Courier New', monospace;
            color: var(--text-muted);
        }

        /* Center - Main Visualization */
        .main-viz {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            min-height: 800px;
        }

        .viz-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .viz-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .viz-subtitle {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        /* Layer Card */
        .layer-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .layer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
            opacity: 0.3;
            transition: all 0.4s;
        }

        .layer-card:hover::before {
            opacity: 0.7;
            width: 6px;
        }

        .layer-card.active {
            border-color: currentColor;
            box-shadow: 0 0 30px currentColor, inset 0 0 15px rgba(255,255,255,0.05);
            transform: translateX(5px);
        }

        .layer-card.active::before {
            opacity: 1;
            width: 6px;
        }

        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .layer-title-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .layer-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: var(--bg-primary);
            font-weight: 700;
        }

        .layer-title {
            font-size: 1.3em;
            font-weight: 700;
        }

        .layer-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            background: currentColor;
            color: var(--bg-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .layer-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 1100px) {
            .layer-details {
                grid-template-columns: 1fr;
            }
        }

        .detail-section {
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            padding: 15px;
        }

        .detail-title {
            font-size: 0.85em;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-content {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: var(--text-primary);
            line-height: 1.8;
        }

        .code-inline {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.95em;
        }

        .highlight {
            color: currentColor;
            font-weight: 700;
        }

        /* Data Flow Visualization */
        .flow-connector {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: -10px 0;
        }

        .flow-line {
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg,
                transparent,
                var(--border) 20%,
                var(--border) 80%,
                transparent);
            position: relative;
        }

        .flow-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .flow-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 15px currentColor;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
        }

        .flow-connector.active .flow-particle {
            animation: flow-particle 2s ease-in-out infinite;
        }

        @keyframes flow-particle {
            0% { top: -10px; opacity: 0; transform: translateX(-50%) scale(0.5); }
            10% { opacity: 1; transform: translateX(-50%) scale(1); }
            90% { opacity: 1; transform: translateX(-50%) scale(1); }
            100% { top: 100%; opacity: 0; transform: translateX(-50%) scale(0.5); }
        }

        .flow-particle:nth-child(2) { animation-delay: 0.4s; }
        .flow-particle:nth-child(3) { animation-delay: 0.8s; }

        /* Right Sidebar - Metrics & Insights */
        .metrics-panel {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .metrics-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .metric-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 3px solid currentColor;
        }

        .metric-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
        }

        .metric-subtext {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-top: 3px;
        }

        /* Performance Chart */
        .perf-chart {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }

        .chart-title {
            font-size: 0.9em;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-bar {
            margin-bottom: 12px;
        }

        .chart-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .chart-bar-fill {
            height: 8px;
            background: currentColor;
            border-radius: 4px;
            transition: all 0.6s;
            position: relative;
            overflow: hidden;
        }

        .chart-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 0.85em;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .tooltip.show {
            opacity: 1;
        }

        /* Info callout */
        .info-callout {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid var(--accent-primary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .info-callout-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--accent-primary);
        }

        .info-callout-text {
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Loading state */
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .loading {
            background: linear-gradient(270deg, var(--bg-tertiary), var(--bg-secondary), var(--bg-tertiary));
            background-size: 200% 200%;
            animation: gradient-shift 2s ease infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2em;
            }

            .control-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîç Kernel Lens</h1>
            <p>Explore the inner workings of the Linux kernel through interactive visualization</p>
        </header>

        <div class="info-callout">
            <div class="info-callout-title">üí° How to Explore</div>
            <div class="info-callout-text">
                Configure your system call below and click Execute. Watch as data flows through every layer of the kernel stack.
                Hover over any layer to see detailed information. The entire execution path is visible simultaneously -
                observe how parameters affect timing, cache behavior, and I/O operations in real-time.
            </div>
        </div>

        <div class="control-panel">
            <div class="control-grid">
                <div class="control-group">
                    <label class="control-label">System Call</label>
                    <select id="syscall-select">
                        <option value="read">read() - Read from file descriptor</option>
                        <option value="write">write() - Write to file descriptor</option>
                        <option value="open">open() - Open file</option>
                        <option value="stat">stat() - Get file status</option>
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">File Descriptor</label>
                    <input type="number" id="fd-input" value="3" min="0" max="1024">
                </div>
                <div class="control-group">
                    <label class="control-label">Buffer Size (bytes)</label>
                    <input type="number" id="size-input" value="4096" min="1" max="1048576" step="1024">
                </div>
                <div class="control-group">
                    <label class="control-label">Simulate Cache</label>
                    <select id="cache-select">
                        <option value="hot">Hot (High hit rate ~85%)</option>
                        <option value="cold">Cold (Low hit rate ~15%)</option>
                        <option value="mixed">Mixed (~50%)</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="executeSystemCall()">‚ö° Execute System Call</button>
        </div>

        <div class="main-layout">
            <!-- Left: Layer Navigator -->
            <div class="layer-navigator">
                <div class="nav-title">Execution Flow</div>
                <div id="nav-items"></div>
            </div>

            <!-- Center: Main Visualization -->
            <div class="main-viz">
                <div class="viz-header">
                    <div class="viz-title" id="viz-title">System Call Execution Path</div>
                    <div class="viz-subtitle" id="viz-subtitle">Tracing read(fd=3, buf, count=4096) through the kernel</div>
                </div>
                <div id="viz-content"></div>
            </div>

            <!-- Right: Metrics Panel -->
            <div class="metrics-panel">
                <div class="metrics-title">Performance Metrics</div>
                <div id="metrics-content"></div>

                <div class="perf-chart">
                    <div class="chart-title">Time Breakdown</div>
                    <div id="perf-chart-content"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Kernel layer data model
        const kernelLayers = {
            read: [
                {
                    id: 'user',
                    name: 'User Space',
                    badge: 'Ring 3',
                    icon: 'üë§',
                    color: 'var(--layer-user)',
                    time: 0,
                    description: 'Application initiates system call',
                    operations: [
                        { label: 'Function Call', value: 'read(fd, buffer, count)' },
                        { label: 'Stack Setup', value: 'Push parameters to stack' },
                        { label: 'Instruction', value: 'SYSCALL / INT 0x80' }
                    ],
                    details: [
                        { title: 'Process Context', content: 'PID: 1234, UID: 1000\nCPU: User mode, Ring 3\nRegisters: rax=0, rdi=fd, rsi=buf, rdx=count' },
                        { title: 'Memory Layout', content: 'Code: 0x400000-0x401000\nStack: 0x7fff00000000\nHeap: 0x600000+' }
                    ]
                },
                {
                    id: 'syscall',
                    name: 'System Call Interface',
                    badge: 'Ring 0',
                    icon: 'üö™',
                    color: 'var(--layer-syscall)',
                    time: 1,
                    description: 'Transition from user to kernel space',
                    operations: [
                        { label: 'Context Switch', value: 'User ‚Üí Kernel mode transition' },
                        { label: 'Syscall Table', value: 'sys_call_table[__NR_read] ‚Üí sys_read' },
                        { label: 'Parameter Copy', value: 'Copy params from user registers' }
                    ],
                    details: [
                        { title: 'CPU State', content: 'Mode: Kernel (Ring 0)\nPrivilege: Elevated\nCPU Time: ~1Œºs\nContext switches: +1' },
                        { title: 'Entry Point', content: 'SYSCALL_DEFINE3(read, ...)\nValidate parameters\nCheck permissions' }
                    ]
                },
                {
                    id: 'vfs',
                    name: 'Virtual File System',
                    badge: 'VFS',
                    icon: 'üìÇ',
                    color: 'var(--layer-vfs)',
                    time: 0.5,
                    description: 'File system abstraction layer',
                    operations: [
                        { label: 'FD Lookup', value: 'fdget_pos(fd) ‚Üí struct file*' },
                        { label: 'Inode Resolution', value: 'file->f_inode ‚Üí inode 524288' },
                        { label: 'Permission Check', value: 'file_permission(MAY_READ) ‚Üí OK' }
                    ],
                    details: [
                        { title: 'File Structure', content: 'Path: /etc/passwd\nInode: 524288\nSize: 2.1 KB\nf_op: ext4_file_ops' },
                        { title: 'Dentry Cache', content: 'Cache: HIT ‚úì\nLookup: O(1)\nLatency: ~0.5Œºs' }
                    ]
                },
                {
                    id: 'fs',
                    name: 'File System (ext4)',
                    badge: 'EXT4',
                    icon: 'üíæ',
                    color: 'var(--layer-fs)',
                    time: 2,
                    description: 'File system specific operations',
                    operations: [
                        { label: 'Inode Load', value: 'Load inode metadata and extent tree' },
                        { label: 'Block Mapping', value: 'Logical block 0 ‚Üí Physical 12345678' },
                        { label: 'Page Cache', value: 'find_get_page() ‚Üí Cache status' }
                    ],
                    details: [
                        { title: 'Extent Tree', content: 'Logical: 0-7\nPhysical: 12345678-85\nLength: 8 blocks (32KB)\nAllocated: Yes' },
                        { title: 'Cache Status', content: 'Hit rate: <span class="highlight">85%</span>\nPages cached: 6/8\nRead required: 2 blocks' }
                    ]
                },
                {
                    id: 'block',
                    name: 'Block I/O Layer',
                    badge: 'BIO',
                    icon: '‚öôÔ∏è',
                    color: 'var(--layer-block)',
                    time: 10,
                    description: 'Block device I/O scheduling',
                    operations: [
                        { label: 'BIO Creation', value: 'bio_alloc(sector, size, READ)' },
                        { label: 'I/O Scheduler', value: 'mq-deadline: merge/sort queue' },
                        { label: 'Request Queue', value: 'Add to dispatch queue (depth: 12/32)' }
                    ],
                    details: [
                        { title: 'Block Request', content: 'Sector: 98765424\nSize: 4096 bytes\nOperation: READ\nPriority: Normal' },
                        { title: 'Queue Stats', content: 'Depth: 12/32\nWait time: ~10Œºs\nScheduler: mq-deadline' }
                    ]
                },
                {
                    id: 'device',
                    name: 'Device Driver',
                    badge: 'SCSI',
                    icon: 'üîå',
                    color: 'var(--layer-device)',
                    time: 150,
                    description: 'Hardware device interaction',
                    operations: [
                        { label: 'SCSI Command', value: 'READ_10: LBA=98765424, len=4096' },
                        { label: 'DMA Setup', value: 'Setup direct memory access transfer' },
                        { label: 'IRQ Completion', value: 'IRQ 45 ‚Üí scsi_done() callback' }
                    ],
                    details: [
                        { title: 'Device Info', content: 'Device: /dev/sda\nType: SATA SSD\nSpeed: 6 Gbps\nLatency: ~150Œºs' },
                        { title: 'DMA Transfer', content: 'Method: Direct\nAddress: 0x1234abcd0000\nStatus: ‚úì Complete' }
                    ]
                },
                {
                    id: 'return',
                    name: 'Return to User',
                    badge: 'Ring 3',
                    icon: '‚Ü©Ô∏è',
                    color: 'var(--layer-user)',
                    time: 1,
                    description: 'Return data and control to application',
                    operations: [
                        { label: 'Data Copy', value: 'copy_to_user(buf, kernel_buf, 4096)' },
                        { label: 'Return Value', value: 'rax = 4096 (bytes read)' },
                        { label: 'Context Restore', value: 'Kernel ‚Üí User mode (SYSRET)' }
                    ],
                    details: [
                        { title: 'Result', content: 'Bytes read: <span class="highlight">4096</span>\nErrno: 0 (Success)\nReturn code: 4096' },
                        { title: 'Total Time', content: 'Elapsed: <span class="highlight">~175Œºs</span>\nUser: 0Œºs\nKernel: 175Œºs' }
                    ]
                }
            ]
        };

        let currentExecution = null;
        let currentLayer = -1;

        // Initialize
        function init() {
            renderNavigation();
            renderVisualization();
            renderMetrics();

            // Auto-execute on load
            setTimeout(() => executeSystemCall(), 800);
        }

        // Render navigation
        function renderNavigation() {
            const nav = document.getElementById('nav-items');
            const layers = kernelLayers.read;

            nav.innerHTML = layers.map((layer, i) => `
                <div class="nav-item" style="color: ${layer.color}" data-layer="${i}" onmouseenter="highlightLayer(${i})" onmouseleave="unhighlightLayer()">
                    <div class="nav-indicator"></div>
                    <div class="nav-label">${layer.name}</div>
                    <div class="nav-time">${layer.time}Œºs</div>
                </div>
            `).join('');
        }

        // Render visualization
        function renderVisualization() {
            const viz = document.getElementById('viz-content');
            const layers = kernelLayers.read;

            viz.innerHTML = layers.map((layer, i) => `
                ${i > 0 ? `
                    <div class="flow-connector" style="color: ${layer.color}" id="flow-${i}">
                        <div class="flow-line">
                            <div class="flow-particles">
                                <div class="flow-particle"></div>
                                <div class="flow-particle"></div>
                                <div class="flow-particle"></div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <div class="layer-card" style="color: ${layer.color}" id="layer-${i}"
                     onmouseenter="showLayerTooltip(${i}, event)" onmouseleave="hideTooltip()">
                    <div class="layer-header">
                        <div class="layer-title-group">
                            <div class="layer-icon">${layer.icon}</div>
                            <div class="layer-title">${layer.name}</div>
                        </div>
                        <div class="layer-badge">${layer.badge}</div>
                    </div>

                    <div class="layer-details">
                        ${layer.details.map(detail => `
                            <div class="detail-section">
                                <div class="detail-title">${detail.title}</div>
                                <div class="detail-content">${detail.content}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Render metrics
        function renderMetrics() {
            const fd = document.getElementById('fd-input').value;
            const size = document.getElementById('size-input').value;
            const cache = document.getElementById('cache-select').value;

            const cacheRate = cache === 'hot' ? 85 : cache === 'cold' ? 15 : 50;
            const totalTime = 175 + (cache === 'cold' ? 300 : cache === 'hot' ? -50 : 100);

            const metrics = document.getElementById('metrics-content');
            metrics.innerHTML = `
                <div class="metric-card" style="color: var(--success)">
                    <div class="metric-label">Total Time</div>
                    <div class="metric-value">${totalTime}Œºs</div>
                    <div class="metric-subtext">End-to-end latency</div>
                </div>

                <div class="metric-card" style="color: var(--accent-primary)">
                    <div class="metric-label">Bytes Read</div>
                    <div class="metric-value">${size}</div>
                    <div class="metric-subtext">From fd ${fd}</div>
                </div>

                <div class="metric-card" style="color: var(--layer-fs)">
                    <div class="metric-label">Cache Hit Rate</div>
                    <div class="metric-value">${cacheRate}%</div>
                    <div class="metric-subtext">Page cache efficiency</div>
                </div>

                <div class="metric-card" style="color: var(--layer-device)">
                    <div class="metric-label">I/O Operations</div>
                    <div class="metric-value">${Math.ceil((100 - cacheRate) / 100 * 8)}</div>
                    <div class="metric-subtext">Physical disk reads</div>
                </div>
            `;

            // Render performance chart
            const layers = kernelLayers.read;
            const chart = document.getElementById('perf-chart-content');
            const maxTime = Math.max(...layers.map(l => l.time));

            chart.innerHTML = layers.map(layer => {
                const percent = (layer.time / (maxTime * 1.5)) * 100;
                return `
                    <div class="chart-bar" style="color: ${layer.color}">
                        <div class="chart-bar-label">
                            <span>${layer.icon} ${layer.name}</span>
                            <span>${layer.time}Œºs</span>
                        </div>
                        <div class="chart-bar-fill" style="width: ${percent}%"></div>
                    </div>
                `;
            }).join('');
        }

        // Execute system call
        function executeSystemCall() {
            const fd = document.getElementById('fd-input').value;
            const size = document.getElementById('size-input').value;
            const syscall = document.getElementById('syscall-select').options[document.getElementById('syscall-select').selectedIndex].text;

            document.getElementById('viz-subtitle').textContent = `Tracing ${syscall.split(' ')[0]}(fd=${fd}, buf, count=${size}) through the kernel`;

            // Reset
            document.querySelectorAll('.layer-card, .nav-item, .flow-connector').forEach(el => {
                el.classList.remove('active');
            });

            renderMetrics();

            // Animate execution
            animateExecution(0);
        }

        // Animate execution through layers
        function animateExecution(index) {
            const layers = kernelLayers.read;
            if (index >= layers.length) return;

            // Activate current layer
            document.getElementById(`layer-${index}`).classList.add('active');
            document.querySelector(`.nav-item[data-layer="${index}"]`).classList.add('active');

            // Activate flow to next layer
            if (index < layers.length - 1) {
                setTimeout(() => {
                    document.getElementById(`flow-${index + 1}`).classList.add('active');
                }, 200);
            }

            // Deactivate previous layer
            if (index > 0) {
                setTimeout(() => {
                    document.getElementById(`layer-${index - 1}`).classList.remove('active');
                    document.querySelector(`.nav-item[data-layer="${index - 1}"]`).classList.remove('active');
                }, layers[index].time * 8);
            }

            // Move to next layer
            const delay = layers[index].time * 10;
            setTimeout(() => animateExecution(index + 1), delay);
        }

        // Highlight layer on nav hover
        function highlightLayer(index) {
            document.getElementById(`layer-${index}`).style.transform = 'translateX(8px) scale(1.02)';
        }

        function unhighlightLayer() {
            document.querySelectorAll('.layer-card').forEach(el => {
                el.style.transform = '';
            });
        }

        // Show tooltip
        function showLayerTooltip(index, event) {
            const layer = kernelLayers.read[index];
            const tooltip = document.getElementById('tooltip');

            tooltip.innerHTML = `
                <div style="font-weight: 700; margin-bottom: 5px;">${layer.name}</div>
                <div style="color: var(--text-secondary); font-size: 0.9em;">${layer.description}</div>
                <div style="margin-top: 8px; font-size: 0.85em; color: var(--text-muted);">
                    Execution time: <strong>${layer.time}Œºs</strong>
                </div>
            `;

            tooltip.style.left = event.clientX + 15 + 'px';
            tooltip.style.top = event.clientY + 15 + 'px';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('show');
        }

        // Update metrics when parameters change
        ['fd-input', 'size-input', 'cache-select'].forEach(id => {
            document.getElementById(id).addEventListener('change', renderMetrics);
        });

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
