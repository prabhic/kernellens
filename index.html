<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kernel Lens - Data Transformation Visualizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8eaf6;
            min-height: 100vh;
            padding: 40px 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -1px;
        }

        .header p {
            font-size: 18px;
            color: #9fa8da;
            font-weight: 400;
        }

        /* Control Panel */
        .controls {
            background: rgba(30, 37, 66, 0.6);
            border: 1px solid #283593;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 50px;
            backdrop-filter: blur(10px);
        }

        .control-row {
            display: flex;
            gap: 24px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-group label {
            font-size: 14px;
            color: #9fa8da;
            font-weight: 600;
            white-space: nowrap;
        }

        .control-group select,
        .control-group input {
            background: #1e2542;
            border: 1px solid #3949ab;
            border-radius: 8px;
            padding: 10px 14px;
            color: #e8eaf6;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            outline: none;
            transition: all 0.2s;
        }

        .control-group select:focus,
        .control-group input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .control-group input {
            width: 110px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 32px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-left: 20px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Info Box */
        .info-box {
            background: rgba(102, 126, 234, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 40px;
            font-size: 15px;
            color: #9fa8da;
            line-height: 1.7;
            text-align: center;
        }

        .info-box strong {
            color: #667eea;
            font-weight: 700;
        }

        /* Data Flow Visualization */
        .flow-container {
            position: relative;
            padding: 60px 40px;
            background: rgba(30, 37, 66, 0.4);
            border: 1px solid #283593;
            border-radius: 16px;
            margin-bottom: 50px;
            overflow-x: auto;
        }

        .flow-stages {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            min-width: 1400px;
            padding: 20px 0;
        }

        /* Data Block - The hero of the visualization */
        .data-block {
            background: linear-gradient(135deg, #1e2542 0%, #252d4a 100%);
            border: 3px solid #3949ab;
            border-radius: 16px;
            padding: 24px;
            width: 200px;
            min-height: 180px;
            position: relative;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .data-block:hover {
            transform: translateY(-12px) scale(1.05);
            border-color: #667eea;
            box-shadow: 0 25px 50px rgba(102, 126, 234, 0.5);
            z-index: 10;
        }

        .data-block.active {
            border-color: #4caf50;
            box-shadow: 0 0 40px rgba(76, 175, 80, 0.8), 0 0 80px rgba(76, 175, 80, 0.4);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 40px rgba(76, 175, 80, 0.8), 0 0 80px rgba(76, 175, 80, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 60px rgba(76, 175, 80, 1), 0 0 120px rgba(76, 175, 80, 0.6);
                transform: scale(1.03);
            }
        }

        .data-block-title {
            font-size: 11px;
            color: #5c6bc0;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 800;
            margin-bottom: 16px;
            text-align: center;
            border-bottom: 1px solid #3949ab;
            padding-bottom: 8px;
        }

        .data-content {
            font-size: 14px;
            color: #e8eaf6;
            line-height: 1.8;
        }

        .data-field {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(57, 73, 171, 0.3);
        }

        .data-field:last-child {
            border-bottom: none;
        }

        .data-field-key {
            color: #9fa8da;
            font-weight: 600;
            font-size: 12px;
        }

        .data-field-value {
            color: #4caf50;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        /* Transformation Arrow - The engine */
        .transform-arrow {
            position: relative;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, #3949ab 0%, #5c6bc0 100%);
            opacity: 0.5;
            transition: all 0.5s;
            flex-shrink: 0;
        }

        .transform-arrow.active {
            opacity: 1;
            background: linear-gradient(90deg, #667eea 0%, #4caf50 100%);
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.8);
            animation: flow-pulse 1.5s ease-in-out infinite;
        }

        @keyframes flow-pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .transform-arrow::after {
            content: '';
            position: absolute;
            right: -10px;
            top: -6px;
            width: 0;
            height: 0;
            border-left: 10px solid #5c6bc0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            transition: all 0.5s;
        }

        .transform-arrow.active::after {
            border-left-color: #4caf50;
        }

        /* Transformation Engine Label */
        .transform-engine {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-12px);
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 6px 14px;
            font-size: 10px;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 800;
            white-space: nowrap;
            opacity: 0;
            transition: all 0.3s;
            pointer-events: none;
        }

        .transform-arrow:hover .transform-engine {
            opacity: 1;
            transform: translateX(-50%) translateY(-8px);
        }

        .transform-arrow.active .transform-engine {
            opacity: 1;
            color: #4caf50;
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.15);
        }

        /* Flow Particles */
        .flow-particles {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 100%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .flow-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.9);
            opacity: 0;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .transform-arrow.active .flow-particle {
            animation: particle-flow 2s ease-in-out infinite;
        }

        @keyframes particle-flow {
            0% {
                opacity: 0;
                left: 0;
                transform: translateY(-50%) scale(0.3);
            }
            15% {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
            85% {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
            100% {
                opacity: 0;
                left: 100%;
                transform: translateY(-50%) scale(0.3);
            }
        }

        .flow-particle:nth-child(2) {
            animation-delay: 0.5s;
        }

        .flow-particle:nth-child(3) {
            animation-delay: 1s;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            bottom: calc(100% + 15px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 35, 0.98);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 16px 20px;
            font-size: 13px;
            color: #e8eaf6;
            min-width: 250px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 100;
            line-height: 1.6;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }

        .data-block:hover .tooltip {
            opacity: 1;
            bottom: calc(100% + 10px);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #667eea;
        }

        .tooltip-title {
            font-weight: 700;
            margin-bottom: 6px;
            color: #667eea;
            font-size: 14px;
        }

        .tooltip-text {
            color: #9fa8da;
            font-size: 12px;
        }

        /* Detailed View */
        .detailed-view {
            background: rgba(30, 37, 66, 0.6);
            border: 1px solid #283593;
            border-radius: 16px;
            padding: 40px;
            backdrop-filter: blur(10px);
        }

        .detailed-view h3 {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 30px;
            font-weight: 700;
            text-align: center;
        }

        .transformation-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        .step-card {
            background: linear-gradient(135deg, #1e2542 0%, #252d4a 100%);
            border: 2px solid #3949ab;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
        }

        .step-card:hover {
            border-color: #667eea;
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.3);
            transform: translateY(-5px);
        }

        .step-card h4 {
            font-size: 16px;
            color: #4caf50;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .step-card p {
            font-size: 13px;
            color: #9fa8da;
            line-height: 1.7;
            margin-bottom: 14px;
        }

        .step-card code {
            display: block;
            background: #0f0f23;
            border: 1px solid #283593;
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            color: #e8eaf6;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
        }

        /* Responsive */
        @media (max-width: 1500px) {
            .flow-stages {
                min-width: auto;
                flex-wrap: wrap;
                gap: 30px;
                justify-content: center;
            }

            .transform-arrow {
                transform: rotate(90deg);
                width: 60px;
            }

            .transform-engine {
                transform: translateX(-50%) translateY(-12px) rotate(-90deg);
            }

            .transform-arrow:hover .transform-engine {
                transform: translateX(-50%) translateY(-8px) rotate(-90deg);
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 36px;
            }

            .control-row {
                flex-direction: column;
                gap: 16px;
            }

            .btn {
                margin-left: 0;
                width: 100%;
            }

            .data-block {
                width: 100%;
                max-width: 300px;
            }

            .flow-container {
                padding: 40px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Kernel Lens</h1>
            <p>Watch data transform through the kernel - See abstractions dissolve into reality</p>
        </div>

        <div class="info-box">
            <strong>How it works:</strong> This visualizes how your system call data transforms as it flows through the Linux kernel.
            Each block shows the actual data structure at that stage. Hover over blocks to understand what they represent.
            Watch the data flow from user space all the way to the hardware and back.
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>System Call:</label>
                    <select id="syscall">
                        <option value="read">read()</option>
                        <option value="write">write()</option>
                        <option value="open">open()</option>
                    </select>
                </div>

                <div class="control-group">
                    <label>File Descriptor:</label>
                    <input type="number" id="fd" value="3" min="0" max="1024">
                </div>

                <div class="control-group">
                    <label>Buffer Size:</label>
                    <input type="number" id="size" value="4096" min="1" max="1048576">
                </div>

                <div class="control-group">
                    <label>Cache:</label>
                    <select id="cache">
                        <option value="hot">Hot (85% hit)</option>
                        <option value="cold">Cold (15% hit)</option>
                    </select>
                </div>

                <button class="btn" onclick="executeFlow()">‚ñ∂ Execute Flow</button>
            </div>
        </div>

        <div class="flow-container">
            <div class="flow-stages" id="flowStages">
                <!-- Stage 1: User Input -->
                <div class="data-block" data-stage="0">
                    <div class="tooltip">
                        <div class="tooltip-title">User Space Parameters</div>
                        <div class="tooltip-text">Application provides file descriptor, buffer pointer, and size before making the system call</div>
                    </div>
                    <div class="data-block-title">User Input</div>
                    <div class="data-content">
                        <div class="data-field">
                            <span class="data-field-key">fd:</span>
                            <span class="data-field-value" id="user-fd">3</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">buf:</span>
                            <span class="data-field-value">0x7fff‚Ä¶</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">size:</span>
                            <span class="data-field-value" id="user-size">4096</span>
                        </div>
                    </div>
                </div>

                <div class="transform-arrow" data-arrow="0">
                    <div class="transform-engine">SYSCALL</div>
                    <div class="flow-particles">
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                    </div>
                </div>

                <!-- Stage 2: Kernel Request -->
                <div class="data-block" data-stage="1">
                    <div class="tooltip">
                        <div class="tooltip-title">Kernel Request</div>
                        <div class="tooltip-text">User parameters are packaged into kernel structures. CPU switches from Ring 3 to Ring 0 (kernel mode)</div>
                    </div>
                    <div class="data-block-title">Kernel Request</div>
                    <div class="data-content">
                        <div class="data-field">
                            <span class="data-field-key">syscall:</span>
                            <span class="data-field-value" id="kern-syscall">read</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">ring:</span>
                            <span class="data-field-value">0</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">pid:</span>
                            <span class="data-field-value">1234</span>
                        </div>
                    </div>
                </div>

                <div class="transform-arrow" data-arrow="1">
                    <div class="transform-engine">VFS LOOKUP</div>
                    <div class="flow-particles">
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                    </div>
                </div>

                <!-- Stage 3: File Object -->
                <div class="data-block" data-stage="2">
                    <div class="tooltip">
                        <div class="tooltip-title">File Object</div>
                        <div class="tooltip-text">VFS resolves file descriptor to actual file structure containing path, inode, and position</div>
                    </div>
                    <div class="data-block-title">File Object</div>
                    <div class="data-content">
                        <div class="data-field">
                            <span class="data-field-key">path:</span>
                            <span class="data-field-value">/etc/passwd</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">mode:</span>
                            <span class="data-field-value">r--</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">pos:</span>
                            <span class="data-field-value">0</span>
                        </div>
                    </div>
                </div>

                <div class="transform-arrow" data-arrow="2">
                    <div class="transform-engine">FS RESOLVE</div>
                    <div class="flow-particles">
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                    </div>
                </div>

                <!-- Stage 4: Inode & Blocks -->
                <div class="data-block" data-stage="3">
                    <div class="tooltip">
                        <div class="tooltip-title">Inode & Blocks</div>
                        <div class="tooltip-text">Filesystem (ext4) maps the file to inode number and physical block addresses on disk</div>
                    </div>
                    <div class="data-block-title">Inode & Blocks</div>
                    <div class="data-content">
                        <div class="data-field">
                            <span class="data-field-key">inode:</span>
                            <span class="data-field-value">524288</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">blocks:</span>
                            <span class="data-field-value">[12M‚Ä¶]</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">cache:</span>
                            <span class="data-field-value" id="cache-status">HIT</span>
                        </div>
                    </div>
                </div>

                <div class="transform-arrow" data-arrow="3">
                    <div class="transform-engine">BLOCK I/O</div>
                    <div class="flow-particles">
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                    </div>
                </div>

                <!-- Stage 5: Disk I/O -->
                <div class="data-block" data-stage="4">
                    <div class="tooltip">
                        <div class="tooltip-title">Disk I/O Request</div>
                        <div class="tooltip-text">Block layer creates I/O request with sector number and schedules it for device driver</div>
                    </div>
                    <div class="data-block-title">Disk I/O</div>
                    <div class="data-content">
                        <div class="data-field">
                            <span class="data-field-key">sector:</span>
                            <span class="data-field-value">24576</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">ops:</span>
                            <span class="data-field-value" id="io-ops">1</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">DMA:</span>
                            <span class="data-field-value">active</span>
                        </div>
                    </div>
                </div>

                <div class="transform-arrow" data-arrow="4">
                    <div class="transform-engine">DATA COPY</div>
                    <div class="flow-particles">
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                    </div>
                </div>

                <!-- Stage 6: Raw Data -->
                <div class="data-block" data-stage="5">
                    <div class="tooltip">
                        <div class="tooltip-title">Raw File Content</div>
                        <div class="tooltip-text">Actual file bytes retrieved from disk (or page cache) ready to be copied to user buffer</div>
                    </div>
                    <div class="data-block-title">Raw Data</div>
                    <div class="data-content">
                        <div class="data-field">
                            <span class="data-field-key">bytes:</span>
                            <span class="data-field-value" id="data-bytes">4096</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">data:</span>
                            <span class="data-field-value">"root:x‚Ä¶"</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">valid:</span>
                            <span class="data-field-value">‚úì</span>
                        </div>
                    </div>
                </div>

                <div class="transform-arrow" data-arrow="5">
                    <div class="transform-engine">RETURN</div>
                    <div class="flow-particles">
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                        <div class="flow-particle"></div>
                    </div>
                </div>

                <!-- Stage 7: User Result -->
                <div class="data-block" data-stage="6">
                    <div class="tooltip">
                        <div class="tooltip-title">User Result</div>
                        <div class="tooltip-text">Data copied to user buffer, control returns to application (Ring 0 ‚Üí Ring 3)</div>
                    </div>
                    <div class="data-block-title">User Result</div>
                    <div class="data-content">
                        <div class="data-field">
                            <span class="data-field-key">return:</span>
                            <span class="data-field-value" id="result-bytes">4096</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">errno:</span>
                            <span class="data-field-value">0</span>
                        </div>
                        <div class="data-field">
                            <span class="data-field-key">time:</span>
                            <span class="data-field-value" id="result-time">125Œºs</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="detailed-view">
            <h3>üìñ Data Transformation Details</h3>
            <div class="transformation-steps">
                <div class="step-card">
                    <h4>1. User ‚Üí Kernel (SYSCALL)</h4>
                    <p>User space parameters (fd, buffer, size) are packaged into a system call. The CPU switches from Ring 3 to Ring 0, and control transfers to the kernel.</p>
                    <code>ssize_t read(int fd, void *buf, size_t count);</code>
                </div>

                <div class="step-card">
                    <h4>2. Kernel Request (VFS LOOKUP)</h4>
                    <p>The Virtual File System (VFS) resolves the file descriptor from the process's fd table to locate the actual file structure pointer.</p>
                    <code>struct file *file = fdt->fd[fd];</code>
                </div>

                <div class="step-card">
                    <h4>3. File Object (FS RESOLVE)</h4>
                    <p>The file structure contains metadata (path, permissions, position). The filesystem (ext4) uses this to find the inode and block addresses.</p>
                    <code>struct inode *inode = file->f_inode;</code>
                </div>

                <div class="step-card">
                    <h4>4. Inode & Blocks (BLOCK I/O)</h4>
                    <p>The inode contains extent tree mapping logical blocks to physical blocks. The page cache is checked first (cache hit avoids disk I/O).</p>
                    <code>page = find_get_page(mapping, index);</code>
                </div>

                <div class="step-card">
                    <h4>5. Disk I/O (DATA COPY)</h4>
                    <p>If cache miss, the block layer creates a BIO request, schedules it, and uses DMA to transfer data from disk to kernel memory.</p>
                    <code>submit_bio(READ, bio);</code>
                </div>

                <div class="step-card">
                    <h4>6. Raw Data (RETURN)</h4>
                    <p>The file content is now in kernel memory (page cache). It needs to be copied to the user space buffer safely (copy_to_user checks permissions).</p>
                    <code>copy_to_user(buf, page_address(page), count);</code>
                </div>

                <div class="step-card">
                    <h4>7. User Result</h4>
                    <p>Control returns to user space (Ring 0 ‚Üí Ring 3). The return value indicates bytes read, and errno is set to 0 (success).</p>
                    <code>return count; // 4096 bytes</code>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStage = -1;
        let animationInterval = null;

        function updateParameters() {
            const fd = document.getElementById('fd').value;
            const size = document.getElementById('size').value;
            const cache = document.getElementById('cache').value;
            const syscall = document.getElementById('syscall').value;

            // Update displayed values
            document.getElementById('user-fd').textContent = fd;
            document.getElementById('user-size').textContent = size;
            document.getElementById('kern-syscall').textContent = syscall;
            document.getElementById('data-bytes').textContent = size;
            document.getElementById('result-bytes').textContent = size;

            // Update cache status
            const cacheStatus = cache === 'hot' ? 'HIT' : 'MISS';
            document.getElementById('cache-status').textContent = cacheStatus;

            // Calculate I/O operations based on size
            const ioOps = cache === 'hot' ? 0 : Math.ceil(size / 4096);
            document.getElementById('io-ops').textContent = ioOps;

            // Calculate approximate time
            const baseTime = 125; // microseconds
            const diskTime = cache === 'hot' ? 0 : ioOps * 8000; // 8ms per disk I/O
            const totalTime = baseTime + diskTime;
            const timeStr = totalTime < 1000 ? totalTime + 'Œºs' : (totalTime / 1000).toFixed(1) + 'ms';
            document.getElementById('result-time').textContent = timeStr;
        }

        function executeFlow() {
            // Stop any existing animation
            if (animationInterval) {
                clearInterval(animationInterval);
            }

            // Reset all stages
            document.querySelectorAll('.data-block').forEach(block => {
                block.classList.remove('active');
            });
            document.querySelectorAll('.transform-arrow').forEach(arrow => {
                arrow.classList.remove('active');
            });

            // Update parameters
            updateParameters();

            // Start animation
            currentStage = -1;
            animateNextStage();
        }

        function animateNextStage() {
            // Remove active class from previous stage
            if (currentStage >= 0) {
                const prevBlock = document.querySelector(`[data-stage="${currentStage}"]`);
                if (prevBlock) {
                    prevBlock.classList.remove('active');
                }
                if (currentStage > 0) {
                    const prevArrow = document.querySelector(`[data-arrow="${currentStage - 1}"]`);
                    if (prevArrow) {
                        prevArrow.classList.remove('active');
                    }
                }
            }

            // Move to next stage
            currentStage++;

            if (currentStage <= 6) {
                // Activate current arrow
                if (currentStage > 0) {
                    const arrow = document.querySelector(`[data-arrow="${currentStage - 1}"]`);
                    if (arrow) {
                        arrow.classList.add('active');
                    }
                }

                // Activate current block
                const currentBlock = document.querySelector(`[data-stage="${currentStage}"]`);
                if (currentBlock) {
                    currentBlock.classList.add('active');
                }

                // Schedule next stage
                animationInterval = setTimeout(animateNextStage, 1000);
            } else {
                // Animation complete - keep last block active
                const lastBlock = document.querySelector('[data-stage="6"]');
                if (lastBlock) {
                    lastBlock.classList.add('active');
                }
            }
        }

        // Auto-execute on page load
        window.addEventListener('load', () => {
            setTimeout(executeFlow, 600);
        });

        // Update parameters when changed
        document.getElementById('fd').addEventListener('change', updateParameters);
        document.getElementById('size').addEventListener('change', updateParameters);
        document.getElementById('cache').addEventListener('change', updateParameters);
        document.getElementById('syscall').addEventListener('change', updateParameters);
    </script>
</body>
</html>
